{% extends "base.html" %}
{% block title %}–°—Ç–∞—Ç—É—Å –∫–µ—à–∞{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–µ—à–∞</h2>

  {% if message %}
    <div class="alert alert-success">{{ message }}</div>
  {% endif %}

  <form method="post" class="mb-3">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à</button>
      <a href="{% url 'home' %}" class="btn btn-secondary ms-2">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </form>

  <p><strong>–ö–ª—é—á–µ–π –≤ –∫–µ—à–µ:</strong> <span id="cache-count">{{ count }}</span></p>
  <table class="table table-sm table-striped" id="cache-table">
      <thead>
          <tr>
              <th>–ö–ª—é—á</th>
              <th>TTL (—Å–µ–∫)</th>
          </tr>
      </thead>
      <tbody>
          {% for item in keys %}
          <tr>
              <td><code>{{ item.key }}</code></td>
              <td>{{ item.ttl }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="2" class="text-center">–ö–µ—à –ø—É—Å—Ç</td></tr>
          {% endfor %}
      </tbody>
  </table>

  <p class="text-muted small mt-3">
      –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="cache-time">{{ time|date:"H:i:s" }}</span>
  </p>
</div>

<script>
async function updateCacheTable() {
    try {
        const response = await fetch("{% url 'core:cache_status_json' %}");
        if (!response.ok) return;

        const data = await response.json();
        const tbody = document.querySelector("#cache-table tbody");
        tbody.innerHTML = "";

        if (data.keys.length === 0) {
            tbody.innerHTML = `<tr><td colspan="2" class="text-center">–ö–µ—à –ø—É—Å—Ç</td></tr>`;
        } else {
            data.keys.forEach(item => {
                const row = `<tr>
                    <td><code>${item.key}</code></td>
                    <td>${item.ttl}</td>
                </tr>`;
                tbody.insertAdjacentHTML("beforeend", row);
            });
        }

        document.getElementById("cache-count").textContent = data.count;
        document.getElementById("cache-time").textContent = data.time;

    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞:", err);
    }
}

// üîÑ –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
setInterval(updateCacheTable, 10000);
</script>
{% endblock %}
